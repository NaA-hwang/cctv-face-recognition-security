# FastAPI InsightFace 얼굴 인식 데모

InsightFace를 활용해 업로드한 이미지/영상에서 특정 얼굴을 찾고, 매칭된 얼굴과 일반 얼굴을 색상으로 구분하여 표시하는 웹 데모입니다.

## Tech Stack

- **FastAPI**: 업로드 요청을 받고 InsightFace 추론을 실행하는 백엔드 프레임워크
- **InsightFace** (buffalo_l 모델): 얼굴 검출 및 인식 모델 (retinaface-env2 가상환경 사용)
- **Uvicorn**: FastAPI를 실행하는 ASGI 서버
- **Pillow / OpenCV / numpy**: 이미지/영상 처리 및 바운딩 박스 그리기
- **HTML (Jinja2 템플릿)**: 사용자가 접근할 수 있는 단일 페이지 업로드 UI

## 주요 기능

- **특정 얼굴 찾기**: 찾을 얼굴 이미지와 대상 이미지/영상을 입력받아 특정 얼굴을 찾습니다
- **임베딩 기반 매칭**: InsightFace의 얼굴 임베딩 벡터를 사용하여 코사인 유사도로 얼굴을 비교합니다
- **시각적 구분**: 매칭된 얼굴은 빨간색, 일반 얼굴은 초록색 바운딩 박스로 표시합니다
- **이미지 및 영상 지원**: 이미지와 영상 모두에서 특정 얼굴을 찾을 수 있습니다
- **GPU 자동 감지**: GPU가 있으면 자동으로 사용하고, 없으면 CPU로 실행됩니다

## 준비 사항

1. `retinaface-env2` 가상환경을 사용합니다.
2. 가상환경을 활성화합니다.
   ```bash
   source retinaface-env2/bin/activate
   ```
3. 필요한 패키지가 설치되어 있는지 확인합니다 (InsightFace, FastAPI, OpenCV 등).

## 실행 방법

1. 프로젝트 디렉터리로 이동합니다.
   ```bash
   cd fastapi-test
   ```

2. 가상환경을 활성화합니다 (아직 활성화하지 않은 경우).
   ```bash
   source ../retinaface-env2/bin/activate
   ```

3. FastAPI 앱을 실행합니다.
   ```bash
   uvicorn main:app --reload
   ```

4. 브라우저에서 [http://127.0.0.1:8000](http://127.0.0.1:8000)를 열고 웹 페이지에 접속합니다.

5. 사용 방법:
   - **이미지 탭**: 찾을 얼굴 이미지와 여러 얼굴이 포함된 이미지를 업로드합니다
   - **영상 탭**: 찾을 얼굴 이미지와 여러 얼굴이 포함된 영상을 업로드합니다
   - 결과에서 빨간색 박스는 매칭된 얼굴, 초록색 박스는 일반 얼굴을 나타냅니다

## 동작 방식

- `/` (GET): 업로드 폼을 가진 HTML 페이지를 렌더링합니다.
- `/detect` (POST): 두 개의 이미지 파일을 받습니다.
  - `target_face`: 찾을 얼굴 이미지
  - `search_image`: 여러 얼굴이 포함된 대상 이미지
  - InsightFace의 FaceAnalysis를 사용하여 얼굴을 감지하고 임베딩을 추출합니다
  - 코사인 유사도를 계산하여 임계값(0.3) 이상이면 매칭으로 판단합니다
  - 매칭된 얼굴은 빨간색, 일반 얼굴은 초록색 바운딩 박스로 표시합니다
- `/detect_video` (POST): 찾을 얼굴 이미지와 대상 영상을 받아 각 프레임에 대해 동일한 처리를 수행합니다.

## 결과 표시

- **빨간색 박스**: 매칭된 얼굴 (찾는 얼굴과 일치)
- **초록색 박스**: 일반 얼굴 (찾는 얼굴과 일치하지 않음)
- 각 박스에는 유사도 점수가 표시됩니다

## 참고사항

- InsightFace 모델(buffalo_l)은 첫 실행 시 자동으로 다운로드됩니다
- GPU가 있으면 자동으로 사용하며, 없으면 CPU로 실행됩니다
- 매칭 임계값은 0.3으로 설정되어 있으며, 필요에 따라 조정할 수 있습니다
